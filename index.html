<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:;base64,=">
  </head>

  <body>
    <script type="module">
      import { Client } from './muxado.js';

      const session = new Client({
        serverDomain: "anderspitman.net",
        token: "yolo",
      });

      const enc = new TextEncoder('utf8');

      const CHUNK_LEN = 32*1024;
      const NCHUNKS = 100000;

      let chunkStr = "";
      for (let i = 0; i < CHUNK_LEN; i++ ) {
        chunkStr += "9";
      }

      const chunk = enc.encode(chunkStr);

      (async () => {
        while (true) {

          let stream;

          try {
            stream = await session.accept();
          }
          catch (e) {
            break;
          }
          
          handleStream(stream);
        }
      })();

      async function handleStream(stream) {
        const writer = stream.getWritableStream().getWriter();

        for await (const c of stream.getReadableStream()) {

          const headers = enc.encode(`HTTP/1.1 200\nContent-Length: ${NCHUNKS*chunk.length}\n\n`);

          await writer.write(headers);

          for (let i = 0; i < NCHUNKS; i++) {

            await writer.reader;

            try {
              await writer.write(chunk);
            }
            catch (e) {
              console.error("write failed, other side may have cancelled");
              break;
            }
          }
        }
      }

    </script>
  </body>
</html>
