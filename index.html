<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:;base64,=">
  </head>

  <body>
    <script type="module">
      import { Client } from './muxado.js';

      const session = new Client({
        serverDomain: "anderspitman.net",
        token: "yolo",
      });

      const enc = new TextEncoder('utf8');

      const CHUNK_LEN = 32*1024;
      const NCHUNKS = 1000;

      let chunkStr = "";
      for (let i = 0; i < CHUNK_LEN; i++ ) {
        chunkStr += "9";
      }

      const chunk = enc.encode(chunkStr);


      let windowSize = 256*1024;

      let resolve = null;

      session.onAccept((stream) => {
        stream.onData(async (data) => {
          console.log(new TextDecoder('utf8').decode(data));

          const headers = enc.encode(`HTTP/1.1 200\nContent-Length: ${NCHUNKS*chunk.length}\n\n`);

          await attemptSend(stream, headers);

          for (let i = 0; i < NCHUNKS; i++) {
            await attemptSend(stream, chunk);
          }

        });

        stream.onWindowIncrease((windowIncrease) => {
          windowSize += windowIncrease;
          if (resolve) {
            resolve();
          }
        });
      });

      async function attemptSend(stream, data) {
        if (data.length < windowSize) {
          stream.write(data);
          windowSize -= data.length;
          resolve = null;
        }
        else {
          console.log("new promise");
          await new Promise((newResolve, reject) => {
            resolve = newResolve;
          });

          await attemptSend(stream, data);
        }
      }

    </script>
  </body>
</html>
